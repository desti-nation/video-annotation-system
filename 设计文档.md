# 工作状态视频数据标注系统 - 产品设计文档 (PDD)

## 1. 引言

### 1.1 文档目的
本文档旨在明确工作状态视频数据标注系统的产品需求、功能规格和设计考量，作为开发团队进行设计、开发、测试和部署的主要依据。

### 1.2 产品目标
开发一个高效、易用的 **(Local App Adapt) 本地运行的Web应用程序**，帮助用户对工作状态相关的视频数据进行逐帧或区间标注，生成结构化的标注数据，用于后续的分析和模型训练。用户直接通过浏览器访问本地运行的服务。

### 1.3 目标用户
科研人员、数据分析师、算法工程师等需要对特定行为或状态视频进行标注的专业人士，他们将在自己的计算机上运行此应用。

### 1.4 名词解释
*   **标注 (Annotation)**: 对视频中的某个时间点或时间段赋予一个描述性的文本标签。
*   **区间标注 (Interval Annotation)**: 标记视频中从一个开始时间点到一个结束时间点的时间段。
*   **帧标注 (Frame Annotation)**: 标记视频中的某一个特定帧。
*   **标注数据 (Annotation Data)**: 包含视频信息、时间信息、帧信息、标签和用户ID等的结构化数据。

## 2. 功能需求

### 2.1 用户故事
*   **作为一名数据标注员**，我希望能 **(Local App Adapt) 在应用启动时输入我的用户ID和姓名，并指定一个本地视频文件夹路径**，系统能自动加载该文件夹下的所有视频列表，以便我快速开始工作。
*   **作为一名数据标注员**，我希望能从视频列表中选择任意一个视频进行播放和查看，以便进行标注。
*   **作为一名数据标注员**，我希望能精确控制视频的播放，包括播放、暂停、逐帧前进/后退、拖动进度条，以便定位到需要标注的确切位置。
*   **作为一名数据标注员**，我希望能为一个视频片段（定义开始时间和结束时间）添加文本标签，以描述该时间段内的主要动作或状态。
*   **作为一名数据标注员**，我希望能为视频的某一特定帧添加文本标签，以描述该帧的瞬时动作或状态。
*   **作为一名数据标注员**，我希望能看到当前视频已有的所有标注列表，并能方便地修改或删除任何一条标注。
*   **作为一名数据标注员**，我希望系统能记录我的用户ID和姓名以及标注的详细信息（视频、时间、标签），并以JSON格式 **(Local App Adapt) 直接保存在视频文件旁边或指定的本地目录中**。
*   **作为一名数据标注员**，我希望界面简洁直观，操作便捷，能快速上手，提高标注效率。
*   **作为一名数据标注员**，我希望能将已完成的标注导出为可视化的结果，例如将标注的视频片段和关键帧图片 **(Local App Adapt) 保存到我指定的本地文件夹中**，以便我快速检查标注的准确性。

### 2.2 系统功能详述

#### 2.2.1 用户管理与身份识别
*   **用户身份信息输入**:
    *   **(Local App Adapt) 应用启动后或在主界面，用户需要输入他们的用户ID和姓名。**
    *   这些信息将用于记录是谁进行的标注。
    *   **(Local App Adapt) Flask 后端可以在用户会话中暂存这些信息。如果需要跨应用重启持久化，可以考虑简单的本地配置文件或浏览器 localStorage (但后端也需要知道)。对于纯本地应用，会话级存储可能已足够，或者每次启动时要求输入。**

#### 2.2.2 视频管理
*   **(Local App Adapt) 指定和加载视频文件夹**:
    *   用户通过网页界面上的输入框提供一个 **本地视频文件夹的绝对路径**。
    *   前端将此路径发送给 Flask 后端。
    *   Flask 后端扫描该路径下的所有支持格式的视频文件（如 .mp4, .avi, .mov 等）。
    *   **注意**: Flask应用需要有读取指定路径的权限。
*   **视频列表展示**:
    *   在界面一侧展示从指定路径加载的视频文件列表（显示文件名）。
    *   用户点击列表中的视频文件名，前端请求后端（通过视频的唯一标识符，如相对路径或文件名），后端提供视频流或可直接访问的本地文件URL（通过特定API路由）。
    *   高亮显示当前正在标注的视频。
*   **视频播放控制**:
    *   **播放器**: 内嵌 HTML5 `<video>` 标签。
        *   **(Local App Adapt) `<video>` 标签的 `src` 属性将指向一个 Flask 后端提供的API端点，该端点负责从用户指定的本地路径读取并流式传输视频数据，或者直接指向一个可被浏览器访问的 `file:///` URL（如果浏览器安全策略允许且Flask能构造这样的URL并确保其有效性，但通常通过后端流式传输更可靠）。**
    *   基本控制、进度条、时间显示、帧控制、音量控制、播放速度控制 (与之前Web Adapt一致，由HTML5 video支持)。

#### 2.2.3 标注功能
*   **选择标注类型**:
    *   用户可以选择进行"区间标注"或"帧标注"。
*   **区间标注**:
    *   **设置开始时间**: 用户可以通过按钮（例如"设为开始时间"）或手动输入，将当前视频播放时间点设为区间的开始时间。
    *   **设置结束时间**: 用户可以通过按钮（例如"设为结束时间"）或手动输入，将当前视频播放时间点设为区间的结束时间。开始时间必须早于结束时间。
    *   **时间输入**: 时间输入框应允许 `HH:MM:SS.mmm` 格式。
*   **帧标注**:
    *   **设置当前帧**: 用户可以通过按钮（例如"标记当前帧"）将当前视频播放的帧（或其对应时间戳）设为标注目标。
    *   **帧/时间戳显示**: 清晰显示被标记的帧号或精确时间戳。
*   **标签输入**:
    *   提供一个文本输入框，用户输入对该区间或帧的动作/状态描述。
*   **保存标注**:
    *   "保存"按钮，将当前设置的标注信息（用户ID、视频文件路径/ID、类型、开始/结束时间或帧ID/时间戳、标签）保存。
*   **标注列表展示**:
    *   在界面一侧（例如播放器右侧）展示当前视频已有的所有标注。
    *   每条标注应清晰显示：标签文本、类型（区间/帧）、时间范围或帧信息。
    *   点击列表中的某条标注，视频播放器应能自动跳转到该标注对应的起始位置。
*   **修改标注**:
    *   用户选择一条已有的标注后，可以点击"编辑"按钮。
    *   将该标注的详细信息加载到标注编辑区域（时间、标签等）。
    *   用户修改后，点击"更新"或"保存"按钮覆盖原标注。
*   **删除标注**:
    *   用户选择一条已有的标注后，可以点击"删除"按钮。
    *   系统应有确认提示，防止误删。
    *   确认后，从标注数据中移除该条标注，并更新界面列表。

#### 2.2.4 数据存储与管理
*   **存储格式**: 所有标注信息以JSON格式存储。
*   **(Local App Adapt) 文件位置**:
    *   **视频文件**: 存放在用户最初指定的本地文件夹路径中。系统仅读取这些文件。
    *   **JSON标注文件**:
        *   **推荐方案**: Flask 后端将标注JSON文件保存在原始视频文件所在的目录中，或在其下的一个特定子目录（例如 `.annotations/`）。文件名与视频文件对应，如 `video1.mp4.json`。
        *   用户在进行标注操作（保存、修改、删除）时，Flask后端直接读写这些本地JSON文件。
    *   **JSON结构示例**:
        ```json
        {
          "videoFilePath": "C:/Users/MyUser/Videos/ProjectAlpha/session1/video1.mp4", // (Local App Adapt) 视频文件的绝对路径
          "videoId": "video1.mp4", // 文件名
          "annotatorInfo": { // (Local App Adapt) 新增用户信息
             "id": "user_xyz",
             "name": "John Doe"
          },
          "annotations": [
            {
              "annotationId": "uuid_string_1", // 唯一ID，自动生成
              "userId": "annotator_A",
              "type": "interval", // "interval" 或 "frame"
              "startTime": "00:01:15.250", // 对于 interval 类型
              "endTime": "00:01:20.500",   // 对于 interval 类型
              "label": "使用键盘打字",
              "createdAt": "YYYY-MM-DDTHH:mm:ss.sssZ", // ISO 8601 格式创建时间
              "updatedAt": "YYYY-MM-DDTHH:mm:ss.sssZ"  // ISO 8601 格式最后修改时间
            },
            {
              "annotationId": "uuid_string_2",
              "userId": "annotator_A",
              "type": "frame",
              "timestamp": "00:02:05.120", // 对于 frame 类型，使用精确时间戳
              // "frameId": 12345, // 或者使用帧号，如果能够精确获取
              "label": "查看手机",
              "createdAt": "YYYY-MM-DDTHH:mm:ss.sssZ",
              "updatedAt": "YYYY-MM-DDTHH:mm:ss.sssZ"
            }
            // ... 更多标注
          ]
        }
        ```
*   **(Local App Adapt) 数据加载**: 当用户选择一个视频进行标注时，前端向后端请求（提供视频的标识）。后端根据视频文件路径推断出其对应的JSON标注文件路径，读取内容返回给前端。如果JSON文件不存在，则返回空标注集。
*   **(Local App Adapt) 数据保存**: 用户的每一次新增、修改、删除操作，前端将更新后的标注数据发送给后端API。后端根据视频标识找到对应的本地JSON文件路径并进行读写操作。

#### 2.2.5 标注结果可视化与导出
*   **功能目的**: 方便用户通过查看实际截取的视频片段和帧图片来验证标注的准确性。
*   **触发方式**: 用户可以通过界面上的专用按钮为当前打开的视频执行此操作。
*   **(Local App Adapt) 导出流程**:
    1.  前端提示用户 **选择一个本地文件夹作为导出目标目录**。
    2.  前端将导出请求（包含视频标识、标注信息、以及用户选择的本地输出目录路径）发送给后端API。
    3.  后端 Flask 应用:
        a.  根据视频标识找到原始本地视频文件的路径。
        b.  根据标注信息，使用视频处理库 (如 MoviePy, OpenCV-Python 或 FFmpeg) 从原始本地视频截取片段和提取帧。
        c.  将生成的媒体文件直接保存到用户指定的本地输出目录中。建议在输出目录下为每个视频创建一个子文件夹 (例如 `[用户指定输出目录]/[视频文件名]/`)。
    4.  命名规范建议 (在输出目录内): (与之前一致)
        *   片段: `[原始视频文件名]_[标注ID 或 序号]_[标签]_[startTime]_[endTime].mp4`
        *   图片: `[原始视频文件名]_[标注ID 或 序号]_[标签]_[timestamp].jpg`
    5.  后端API返回操作成功或失败的状态给前端。
*   **反馈**:
    *   前端界面显示导出进度（例如，轮询后端API获取状态，或后端通过WebSocket推送）。
    *   导出完成后，前端显示成功消息，并告知用户文件已保存在其指定的本地目录中。
    *   若导出过程中发生错误，后端API返回错误信息，前端显示给用户。

### 2.3 界面与交互 (UI/UX)
*   **(Local App Adapt) 初始配置区域 (首次访问或未配置时显示)**:
    *   文本框: "用户ID"
    *   文本框: "用户姓名"
    *   文本框: "视频文件夹路径" (例如 `D:\Work\VideoData`)
    *   按钮: "加载/设置"
*   **整体布局**: (三栏式布局依然适用)
    *   左栏: 视频文件列表区 (从指定路径加载)。
    *   中栏: 视频播放器及控制区。
    *   右栏: 标注操作区 和 当前视频的标注列表区。
*   **用户友好性**:
    *   界面简洁明了，功能分区清晰。
    *   操作流程符合直觉，易于上手。
    *   提供必要的提示信息和状态反馈（如"标注已保存至本地"、"导出完成，文件已存至 [用户指定路径]"等）。
*   **错误处理**:
    *   对于无效操作、路径不存在、文件无权限等应有友好提示。
*   **导出操作入口**:
    *   在标注列表区域上方/下方增加一个"导出可视化至本地文件夹"按钮。

## 3. 非功能性需求

### 3.1 易用性
*   新用户无需复杂培训即可上手操作。
*   界面元素和术语清晰易懂。
*   标注流程高效顺畅。

### 3.2 性能
*   视频文件直接从本地文件系统读取，性能应较好，但仍受磁盘IO和视频大小影响。
*   标注信息的保存和加载（读写本地JSON）应非常迅速。
*   视频片段和帧的本地导出过程，速度取决于视频处理库和原始视频的复杂度。

### 3.3 可靠性
*   标注数据准确无误地保存到本地JSON文件。
*   确保文件操作的原子性，避免JSON文件损坏（例如先写临时文件再重命名）。
*   对于文件权限问题有清晰的错误提示。

### 3.4 兼容性
*   **操作系统**: Flask后端 (Python) 和前端 (浏览器) 都是跨平台的。路径处理需要 `os.path` 保证跨平台性。
*   **浏览器兼容性**: 主流现代浏览器。
*   **视频格式**: 前端 `<video>` 支持的格式 (MP4 H.264)。后端视频处理库 (FFmpeg) 可处理更多格式。

### 3.5 可维护性
*   代码结构清晰，前后端模块化设计。
*   Flask后端API接口定义清晰。

## 4. 技术架构设想 (高层次) (Local App Adapt)

### 4.1 前端 (Web 浏览器 - 本地服务)
*   **技术选型**: (与之前Web Adapt一致: HTML5, CSS3, JS, 可选JS框架)
*   **核心元素**:
    *   HTML5 `<video>` 标签，其 `src` 将指向一个Flask后端API端点，用于流式传输本地视频。
    *   输入框用于接收用户ID、姓名和本地视频文件夹路径。
    *   Fetch API 或 Axios 与后端Flask API通信。
*   **主要模块**: (与之前Web Adapt类似，但交互逻辑调整为本地路径)

### 4.2 后端 (Flask - 本地服务)
*   **技术选型**: (与之前Web Adapt一致: Python, Flask, 视频处理库)
*   **主要模块 (Flask 蓝图/路由)**:
    *   `/config` (POST): 接收用户ID、姓名和视频根目录路径，存储在会话或应用上下文中。
    *   `/videos` (GET): 根据已设置的视频根目录路径，列出视频文件。
    *   `/video_stream/<path:relative_video_path>` (GET):
        *   接收相对于配置根目录的视频文件路径。
        *   从本地文件系统读取该视频文件并流式传输给前端。
        *   需要处理HTTP Range requests 以支持视频跳转播放。
    *   `/annotations/<path:relative_video_path>` (GET, POST):
        *   GET: 读取与视频文件（路径由 `relative_video_path` 和配置的根目录拼接得到）相邻的 `.json` 文件。
        *   POST: 保存标注数据到与视频文件相邻的 `.json` 文件。
    *   `/export_visual` (POST):
        *   接收视频标识（如相对路径）、标注信息、以及用户指定的本地输出目录绝对路径。
        *   在指定的本地输出目录生成片段和图片。
*   **(Local App Adapt) 目录结构 (用户机器上的，由用户指定)**:
    ```
    [用户指定的视频文件夹路径, e.g., D:/MyVideos/ProjectX/]
        video1.mp4
        video1.mp4.json  # (标注文件)
        video2.mov
        video2.mov.json  # (标注文件)
        .annotations/    # (或者一个子文件夹存放标注)
            video1.mp4.json
    [用户指定的导出结果文件夹路径, e.g., D:/MyVideos/ProjectX_Exports/]
        video1/
            video1_clip1_label.mp4
            video1_frame_label.jpg
        video2/
            ...
    ```
    Flask 应用本身的代码会放在别处，它只是根据用户给的路径去读写。

### 4.3 数据存储
*   **视频文件**: 用户本地文件系统，由用户提供路径。
*   **标注数据 (JSON)**: 用户本地文件系统，与视频文件存放在一起或在指定子目录。
*   **导出结果**: 用户本地文件系统，存放在用户指定的输出目录。

## 5. UI/UX 设计草图 (概念描述)

### 5.1 主界面 (浏览器页面，访问本地Flask服务如 http://127.0.0.1:5000)
*   **(Local App Adapt) 初始配置区域 (首次访问或未配置时显示)**:
    *   文本框: "用户ID"
    *   文本框: "用户姓名"
    *   文本框: "视频文件夹路径" (例如 `D:\Work\VideoData`)
    *   按钮: "加载/设置"
*   **(Local App Adapt) 导航栏/头部区域 (配置后显示)**:
    *   显示当前用户ID/姓名，当前视频文件夹路径。
    *   按钮: "更改设置" (返回初始配置区域)
*   **左侧面板 (视频列表)**:
    *   标题: "视频列表 (来自: [当前视频文件夹路径])"
    *   ... (与之前类似)
*   **中间面板 (视频播放与控制)**:
    *   视频播放器 `src` 指向 Flask 流式API。
    *   ... (与之前类似)
*   **右侧面板 (标注区)**:
    *   ... (与之前类似)
    *   **标注列表区域**:
        *   按钮: "导出此视频标注可视化 (至本地...)" (点击后会弹出对话框或有输入框让用户指定本地输出文件夹)
        *   按钮: "保存标注" (明确告知用户数据是保存在本地的JSON中)

## 6. 未来规划与潜在增强

*   **预定义标签集**: 用户可以预设常用的标签列表，通过下拉选择或快捷键快速应用。
*   **键盘快捷键**: 为常用操作（播放/暂停、逐帧、设置时间点、保存标注等）增加键盘快捷键，提升效率。
*   **多用户协作**: (需要更复杂的后端和用户管理) 支持多用户同时对同一批数据进行标注，并进行版本控制或合并。
*   **更多视频格式支持**: 通过集成更强大的视频解码库（如 FFmpeg）。
*   **标注数据导出**: 支持导出为其他常见格式（如 CSV, COCO format等）。 **(此处的导出指结构化数据，与可视化导出不同)**
*   **AI辅助预标注**: 集成简单的目标检测或行为识别模型，对视频进行预处理，给出建议标注，用户在此基础上修正。
*   **撤销/重做功能**: 支持对标注操作的撤销和重做。
*   **波形图显示**: （高级）在时间轴下方显示音频波形图，辅助定位事件。
*   **项目管理**: 支持创建"项目"，一个项目包含一个视频集和其对应的标注配置。
*   **批量导出**: 支持一次性导出多个选定视频的标注可视化结果。
*   **自定义导出命名规则**: 允许用户配置导出文件的命名模板。
*   **导出时可选是否包含标签等信息在文件名中**。
*   **(Local App Adapt) 项目文件**: 引入 `.project` 文件的概念，该文件存储了视频文件夹路径、用户ID/姓名等配置，用户可以直接打开项目文件来恢复工作环境。
*   **(Local App Adapt) 更好的路径输入**: 对于视频文件夹路径和导出路径，如果能集成系统原生文件/文件夹选择对话框会更友好（这在Web前端直接做有难度，但可以通过Flask后端触发，或使用一些Electron+Webview的混合方案，不过当前设定是纯Web+Flask）。
*   **FFmpeg集成**: 若使用FFmpeg，确保其能被Flask应用找到（PATH环境变量或指定路径）。

## 7. 风险与挑战
*   **(Local App Adapt) 文件系统权限**: Flask应用（即运行Python脚本的用户）必须拥有对用户指定视频文件夹的读权限，以及对标注文件保存位置（通常是同一文件夹或子文件夹）和导出目标文件夹的写权限。
*   **(Local App Adapt) 路径处理的健壮性**: 正确处理不同操作系统下的路径分隔符、特殊字符等。`pathlib` 库优于 `os.path`。
*   **(Local App Adapt) 安全性 (本地上下文)**: 虽然是本地运行，但如果用户输入任意路径，并且后端代码拼接路径时不谨慎，仍有极小的目录遍历风险（例如，如果用户输入的视频路径是 `../../../../etc/passwd` 而你的代码直接用它）。对用户提供的路径进行适当的规范化和校验是好的实践。
*   **(Local App Adapt) 视频流式传输**: Flask 后端需要正确实现视频流式传输，支持 HTTP Range requests，否则视频拖动（seek）可能无法正常工作或效率低下。
*   **FFmpeg依赖**: (同前)
*   **磁盘空间管理**: 虽然是用户本地磁盘，但仍需注意导出大量数据可能占用空间。

---
本文档将作为后续开发工作的基础，并可能根据项目进展进行迭代和更新。
